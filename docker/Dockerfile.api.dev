# Development Dockerfile for NestJS API
# Multi-stage build for development with hot reloading

FROM node:20-alpine AS base

# Install system dependencies
RUN apk add --no-cache \
    curl \
    wget \
    bash \
    git \
    python3 \
    make \
    g++

# Set working directory
WORKDIR /app

# Install bun globally first
RUN npm install -g bun

# Install NestJS CLI globally for development
RUN bun install -g @nestjs/cli

# Copy workspace configuration files
COPY package.json bun.lock* ./
COPY turbo.json ./
COPY tsconfig.json ./

# Copy all packages to resolve workspace dependencies
COPY packages/ ./packages/
COPY apps/api/package.json ./apps/api/

# Install all dependencies from workspace root (this resolves catalog references)
RUN bun install

# Copy API source code
COPY apps/api ./apps/api

# Set development environment
ENV NODE_ENV=development
ENV LOG_LEVEL=debug
ENV API_PORT=3001

# Change to API directory
WORKDIR /app/apps/api

# Expose port
EXPOSE 3001

# Start development server with hot reloading
CMD ["bun", "run", "start:dev"]
