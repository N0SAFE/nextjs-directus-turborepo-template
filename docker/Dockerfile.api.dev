# Development Dockerfile for NestJS API
# Multi-stage build for development with hot reloading

FROM node:24-alpine AS base

# Install system dependencies
RUN apk add --no-cache \
    curl \
    wget \
    bash \
    git \
    python3 \
    make \
    g++ \
    supervisor

# Set working directory
WORKDIR /app

# Install bun globally first
RUN npm install -g bun

# Install NestJS CLI globally for development
RUN bun install -g @nestjs/cli

# Copy workspace configuration files
COPY package.json bun.lock* ./
COPY turbo.json ./
COPY tsconfig.json ./

# Copy all packages to resolve workspace dependencies
COPY packages/ ./packages/
COPY apps/api/package.json ./apps/api/

# Install all dependencies from workspace root (this resolves catalog references)
RUN bun install

# Copy API source code
COPY apps/api ./apps/api

# Copy supervisord config
COPY apps/api/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Set development environment
ENV NODE_ENV=development
ENV LOG_LEVEL=debug

# Stay in workspace root to maintain access to all packages
WORKDIR /app

# Start development server with hot reloading from workspace root
CMD ["sh", "-c", "bun run --cwd apps/api db:migrate && /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf"]
