name: CI/CD Pipeline

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

env:
    BUN_VERSION: "1.2.14"
    NODE_VERSION: "22"

jobs:
    # Job 1: Lint and Type Check
    lint-and-typecheck:
        name: ðŸ” Lint & Type Check
        runs-on: ubuntu-latest
        timeout-minutes: 10
        env:
            # Essential environment variables for linting/type checking
            NEXT_PUBLIC_API_URL: http://localhost:8055/
            NEXT_PUBLIC_API_PORT: 8055
            API_PING_PATH: /server/health
            API_ADMIN_TOKEN: ci-test-admin-token
            NEXT_PUBLIC_APP_URL: http://localhost:3003/
            NEXT_PUBLIC_APP_PORT: 3003
            AUTH_SECRET: ci-test-auth-secret
            DIRECTUS_SECRET: ci-test-directus-secret
            DIRECTUS_ADMIN_EMAIL: ci-admin@test.com
            DIRECTUS_ADMIN_PASSWORD: ci-test-password
            NEXT_TELEMETRY_DISABLED: 1
            NODE_ENV: test
            MILLION_LINT: false
            REACT_SCAN: false
            SHOW_AUTH_LOGS: false
            NEXT_PUBLIC_SHOW_AUTH_LOGS: false

        steps:
            - name: ðŸ“š Checkout repository
              uses: actions/checkout@v4

            - name: ðŸ° Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: ${{ env.BUN_VERSION }}

            - name: ðŸ“¦ Install dependencies
              run: bun install --frozen-lockfile

            - name: ðŸ” Run ESLint
              run: bun run lint

            - name: ðŸŽ¨ Check formatting with Prettier
              run: bun run format

    # Job 2: Build and Test
    build-and-test:
        name: ðŸ—ï¸ Build & Test
        runs-on: ubuntu-latest
        timeout-minutes: 20
        needs: lint-and-typecheck
        env:
            # API Configuration
            NEXT_PUBLIC_API_URL: http://localhost:8055/
            NEXT_PUBLIC_API_PORT: 8055
            API_PING_PATH: /server/health
            API_ADMIN_TOKEN: ci-test-admin-token

            # App Configuration
            NEXT_PUBLIC_APP_URL: http://localhost:3003/
            NEXT_PUBLIC_APP_PORT: 3003

            # Database Configuration (for testing)
            DB_DATABASE: directus_test
            DB_ROOT_PASSWORD: test-password

            # Authentication
            AUTH_SECRET: ci-test-auth-secret-QgafJQw3O-k1gambz7YGKjtj5ZZe0dnL-WlSw4PtMDc

            # Directus Configuration
            DIRECTUS_SECRET: ci-test-directus-secret-value
            DIRECTUS_ADMIN_EMAIL: ci-admin@test.com
            DIRECTUS_ADMIN_PASSWORD: ci-test-password

            # Next.js Configuration
            NEXT_TELEMETRY_DISABLED: 1
            NODE_ENV: test

            # Development tools (disabled for CI)
            MILLION_LINT: false
            REACT_SCAN: false
            SHOW_AUTH_LOGS: false
            NEXT_PUBLIC_SHOW_AUTH_LOGS: false

        steps:
            - name: ðŸ“š Checkout repository
              uses: actions/checkout@v4

            - name: ðŸ° Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: ${{ env.BUN_VERSION }}

            - name: ðŸ“¦ Install dependencies
              run: bun install --frozen-lockfile

            - name: ðŸ—ï¸ Build packages
              run: |
                  # Build shared packages first
                  bun x turbo run build --filter="!web"
                  # Build web app without static generation to avoid API calls
                  bun run --cwd apps/web compile

            - name: ðŸ§ª Run tests for all packages
              run: bun run test

            - name: ðŸ“Š Upload coverage reports
              uses: codecov/codecov-action@v4
              with:
                  files: |
                      ./coverage/coverage-final.json
                      ./apps/web/coverage/coverage-final.json
                      ./apps/api/coverage/coverage-final.json
                      ./packages/*/coverage/coverage-final.json
                  flags: all-packages
                  name: all-packages-coverage
                  fail_ci_if_error: false
              env:
                  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    # Job 3: Merge Coverage Reports
    merge-coverage:
        name: ðŸ“Š Merge Coverage Reports
        runs-on: ubuntu-latest
        timeout-minutes: 10
        needs: build-and-test
        if: always() && needs.build-and-test.result == 'success'
        env:
            # API Configuration
            NEXT_PUBLIC_API_URL: http://localhost:8055/
            NEXT_PUBLIC_API_PORT: 8055
            API_PING_PATH: /server/health
            API_ADMIN_TOKEN: ci-test-admin-token

            # App Configuration
            NEXT_PUBLIC_APP_URL: http://localhost:3003/
            NEXT_PUBLIC_APP_PORT: 3003

            # Database Configuration (for testing)
            DB_DATABASE: directus_test
            DB_ROOT_PASSWORD: test-password

            # Authentication
            AUTH_SECRET: ci-test-auth-secret-QgafJQw3O-k1gambz7YGKjtj5ZZe0dnL-WlSw4PtMDc

            # Directus Configuration
            DIRECTUS_SECRET: ci-test-directus-secret-value
            DIRECTUS_ADMIN_EMAIL: ci-admin@test.com
            DIRECTUS_ADMIN_PASSWORD: ci-test-password

            # Next.js Configuration
            NEXT_TELEMETRY_DISABLED: 1
            NODE_ENV: test

            # Development tools (disabled for CI)
            MILLION_LINT: false
            REACT_SCAN: false
            SHOW_AUTH_LOGS: false
            NEXT_PUBLIC_SHOW_AUTH_LOGS: false

        steps:
            - name: ðŸ“š Checkout repository
              uses: actions/checkout@v4

            - name: ðŸ° Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: ${{ env.BUN_VERSION }}

            - name: ðŸ“¦ Install dependencies
              run: bun install --frozen-lockfile

            - name: ðŸ—ï¸ Build all packages
              run: |
                  # Build shared packages first
                  bun x turbo run build --filter="!web"
                  # Build web app without static generation to avoid API calls
                  cd apps/web && bun x next build --experimental-build-mode=compile

            - name: ðŸ§ª Run all tests with coverage
              run: bun run test:coverage

            - name: ðŸ“Š Generate merged coverage report
              run: |
                  mkdir -p coverage/report
                  echo "ðŸ“‹ Coverage Summary:" > coverage/report/summary.txt
                  if [ -f "coverage/report/index.html" ]; then
                    echo "âœ… Merged coverage report generated successfully" >> coverage/report/summary.txt
                  else
                    echo "âš ï¸ No coverage data found" >> coverage/report/summary.txt
                  fi

            - name: ðŸ“¤ Upload merged coverage artifact
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report
                  path: |
                      coverage/report/
                      coverage/coverage-final.json
                  retention-days: 30

            # - name: ðŸ“Š Upload to Codecov
            #   uses: codecov/codecov-action@v4
            #   with:
            #       files: ./coverage/coverage-final.json
            #       flags: merged
            #       name: merged-coverage
            #       fail_ci_if_error: false
            #   env:
            #       CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    # Job 4: Deployment Ready Check
    deployment-ready:
        name: ðŸš€ Deployment Ready
        runs-on: ubuntu-latest
        timeout-minutes: 5
        needs: [lint-and-typecheck, build-and-test, merge-coverage]
        if: always()

        steps:
            - name: ðŸ“š Checkout repository
              uses: actions/checkout@v4

            - name: âœ… Check deployment readiness
              run: |
                  echo "ðŸ” Checking CI/CD pipeline results..."

                  LINT_STATUS="${{ needs.lint-and-typecheck.result }}"
                  BUILD_STATUS="${{ needs.build-and-test.result }}"
                  COVERAGE_STATUS="${{ needs.merge-coverage.result }}"

                  echo "ðŸ“‹ Pipeline Results:"
                  echo "  - Lint & Type Check: $LINT_STATUS"
                  echo "  - Build & Test: $BUILD_STATUS"
                  echo "  - Coverage Merge: $COVERAGE_STATUS"

                  if [ "$LINT_STATUS" = "success" ] && [ "$BUILD_STATUS" = "success" ]; then
                    if [ "${{ github.ref }}" = "refs/heads/main" ]; then
                      if [ "$DOCKER_STATUS" = "success" ]; then
                        echo "ðŸš€ âœ… Ready for production deployment!"
                        echo "deployment_ready=true" >> $GITHUB_OUTPUT
                      else
                        echo "ðŸš€ âš ï¸ Code is ready but Docker build failed"
                        echo "deployment_ready=false" >> $GITHUB_OUTPUT
                      fi
                    else
                      echo "ðŸš€ âœ… Ready for staging deployment!"
                      echo "deployment_ready=true" >> $GITHUB_OUTPUT
                    fi
                  else
                    echo "ðŸš€ âŒ Not ready for deployment"
                    echo "deployment_ready=false" >> $GITHUB_OUTPUT
                    exit 1
                  fi

            - name: ðŸ“‹ Generate deployment summary
              run: |
                  echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
                  echo "| Lint & Type Check | ${{ needs.lint-and-typecheck.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Build & Test | ${{ needs.build-and-test.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Coverage Reports | ${{ needs.merge-coverage.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  if [ "${{ github.ref }}" = "refs/heads/main" ]; then
                    echo "ðŸŽ¯ **Branch**: Production (main)" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "ðŸŽ¯ **Branch**: Development" >> $GITHUB_STEP_SUMMARY
                  fi
