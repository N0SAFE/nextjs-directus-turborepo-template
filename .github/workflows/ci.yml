name: CI/CD Pipeline

on:
    push:
        branches: [main]
    pull_request:
        # Run tests on all PRs regardless of target branch
        branches: ["**"]

env:
    BUN_VERSION: "1.2.14"
    NODE_VERSION: "22"

jobs:
    # Job 0: Generate Declarative Routes
    generate-declarative-routes:
        name: ðŸ“ Generate Declarative Routes
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - name: ðŸ“š Checkout repository
              uses: actions/checkout@v4

            - name: ðŸ° Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: ${{ env.BUN_VERSION }}

            - name: ðŸ“¦ Install dependencies
              run: |
                if [ "${{ github.actor }}" = "dependabot[bot]" ]; then
                  echo "Dependabot PR detected: running bun install without --frozen-lockfile"
                  bun install
                else
                  bun install --frozen-lockfile
                fi

            - name: ðŸ“ Generate declarative routes
              run: bun run --cwd apps/web dr:build

            - name: ðŸ“ Generate OpenAPI documentation
              run: |
                  cd apps/web
                  bun run openapi:yaml
                  bun run openapi:html

            - name: ðŸ“¤ Upload declarative routes artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: declarative-routes
                  path: |
                      apps/web/src/routes/index.ts
                      apps/web/src/routes/openapi.ts
                      apps/web/openapi-docs.yml
                      apps/web/redoc-static.html
                  retention-days: 1

    # Job 1: Lint and Type Check
    lint-and-typecheck:
        name: ðŸ” Lint & Type Check
        runs-on: ubuntu-latest
        timeout-minutes: 10
        needs: generate-declarative-routes
        env:
            # Essential environment variables for linting/type checking
            API_URL: http://localhost:8055/
            API_PORT: 8055
            API_PING_PATH: /server/health
            API_ADMIN_TOKEN: ci-test-admin-token
            NEXT_PUBLIC_APP_URL: http://localhost:3003/
            NEXT_PUBLIC_APP_PORT: 3003
            AUTH_SECRET: ci-test-auth-secret
            DIRECTUS_SECRET: ci-test-directus-secret
            DIRECTUS_ADMIN_EMAIL: ci-admin@test.com
            DIRECTUS_ADMIN_PASSWORD: ci-test-password
            NEXT_TELEMETRY_DISABLED: 1
            NODE_ENV: test
            MILLION_LINT: false
            REACT_SCAN: false
            SHOW_AUTH_LOGS: false
            NEXT_PUBLIC_SHOW_AUTH_LOGS: false

        steps:
            - name: ðŸ“š Checkout repository
              uses: actions/checkout@v4

            - name: ðŸ° Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: ${{ env.BUN_VERSION }}

            - name: ðŸ“¦ Install dependencies
              run: |
                if [ "${{ github.actor }}" = "dependabot[bot]" ]; then
                  echo "Dependabot PR detected: running bun install without --frozen-lockfile"
                  bun install
                else
                  bun install --frozen-lockfile
                fi

            - name: ðŸ“¥ Download declarative routes artifacts
              uses: actions/download-artifact@v4
              with:
                  name: declarative-routes
                  path: .

            - name: ðŸ” Verify downloaded artifacts
              run: |
                  echo "ðŸ“‹ Checking downloaded declarative routes artifacts..."
                  echo "Current directory: $(pwd)"
                  echo "Files in apps/web/src/routes/:"
                  ls -la apps/web/src/routes/ || echo "âŒ apps/web/src/routes/ directory not found"
                  echo "Checking for index.ts:"
                  if [ -f "apps/web/src/routes/index.ts" ]; then
                    echo "âœ… index.ts found"
                    head -5 apps/web/src/routes/index.ts
                  else
                    echo "âŒ index.ts not found"
                  fi
                  echo "Checking for openapi.ts:"
                  if [ -f "apps/web/src/routes/openapi.ts" ]; then
                    echo "âœ… openapi.ts found" 
                  else
                    echo "âŒ openapi.ts not found"
                  fi

            - name: ðŸ”§ Generate routes as fallback (if missing)
              run: |
                  if [ ! -f "apps/web/src/routes/index.ts" ]; then
                    echo "âš ï¸ index.ts missing, regenerating declarative routes..."
                    cd apps/web && bun run dr:build
                  else
                    echo "âœ… index.ts exists, skipping regeneration"
                  fi

            - name: ðŸ” Run ESLint
              run: bun run lint

            - name: ðŸŽ¨ Check formatting with Prettier
              run: bun run format

    # Job 2: Build
    build:
        name: ðŸ—ï¸ Build
        runs-on: ubuntu-latest
        timeout-minutes: 15
        needs: [lint-and-typecheck, generate-declarative-routes]
        env:
            # API Configuration
            API_URL: http://localhost:8055/
            API_PORT: 8055
            API_PING_PATH: /server/health
            API_ADMIN_TOKEN: ci-test-admin-token

            # App Configuration
            NEXT_PUBLIC_APP_URL: http://localhost:3003/
            NEXT_PUBLIC_APP_PORT: 3003

            # Database Configuration (for testing)
            DB_DATABASE: directus_test
            DB_ROOT_PASSWORD: test-password

            # Authentication
            AUTH_SECRET: ci-test-auth-secret-QgafJQw3O-k1gambz7YGKjtj5ZZe0dnL-WlSw4PtMDc

            # Directus Configuration
            DIRECTUS_SECRET: ci-test-directus-secret-value
            DIRECTUS_ADMIN_EMAIL: ci-admin@test.com
            DIRECTUS_ADMIN_PASSWORD: ci-test-password

            # Next.js Configuration
            NEXT_TELEMETRY_DISABLED: 1
            NODE_ENV: test

            # Development tools (disabled for CI)
            MILLION_LINT: false
            REACT_SCAN: false
            SHOW_AUTH_LOGS: false
            NEXT_PUBLIC_SHOW_AUTH_LOGS: false
            
            # Build optimization
            SKIP_STATIC_GENERATION: true

        steps:
            - name: ðŸ“š Checkout repository
              uses: actions/checkout@v4

            - name: ðŸ° Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: ${{ env.BUN_VERSION }}

            - name: ðŸ“¦ Install dependencies
              run: |
                if [ "${{ github.actor }}" = "dependabot[bot]" ]; then
                  echo "Dependabot PR detected: running bun install without --frozen-lockfile"
                  bun install
                else
                  bun install --frozen-lockfile
                fi

            - name: ðŸ“¥ Download declarative routes artifacts
              uses: actions/download-artifact@v4
              with:
                  name: declarative-routes
                  path: .

            - name: ðŸ” Verify downloaded artifacts
              run: |
                  echo "ðŸ“‹ Checking downloaded declarative routes artifacts..."
                  echo "Current directory: $(pwd)"
                  echo "Files in apps/web/src/routes/:"
                  ls -la apps/web/src/routes/ || echo "âŒ apps/web/src/routes/ directory not found"
                  echo "Checking for index.ts:"
                  if [ -f "apps/web/src/routes/index.ts" ]; then
                    echo "âœ… index.ts found"
                    head -5 apps/web/src/routes/index.ts
                  else
                    echo "âŒ index.ts not found"
                  fi
                  echo "Checking for openapi.ts:"
                  if [ -f "apps/web/src/routes/openapi.ts" ]; then
                    echo "âœ… openapi.ts found" 
                  else
                    echo "âŒ openapi.ts not found"
                  fi

            - name: ðŸ”§ Generate routes as fallback (if missing)
              run: |
                  if [ ! -f "apps/web/src/routes/index.ts" ]; then
                    echo "âš ï¸ index.ts missing, regenerating declarative routes..."
                    cd apps/web && bun run dr:build
                  else
                    echo "âœ… index.ts exists, skipping regeneration"
                  fi

            - name: ðŸ—ï¸ Build packages
              run: |
                  # Build shared packages first
                  bun x turbo run build --filter="!web"
                  # Build web app without static generation to avoid API calls
                  bun run --cwd apps/web compile

    # Job 3: Test
    test:
        name: ðŸ§ª Test
        runs-on: ubuntu-latest
        timeout-minutes: 15
        needs: [lint-and-typecheck, generate-declarative-routes]
        env:
            # API Configuration
            API_URL: http://localhost:8055/
            API_PORT: 8055
            API_PING_PATH: /server/health
            API_ADMIN_TOKEN: ci-test-admin-token

            # App Configuration
            NEXT_PUBLIC_APP_URL: http://localhost:3003/
            NEXT_PUBLIC_APP_PORT: 3003

            # Database Configuration (for testing)
            DB_DATABASE: directus_test
            DB_ROOT_PASSWORD: test-password

            # Authentication
            AUTH_SECRET: ci-test-auth-secret-QgafJQw3O-k1gambz7YGKjtj5ZZe0dnL-WlSw4PtMDc

            # Directus Configuration
            DIRECTUS_SECRET: ci-test-directus-secret-value
            DIRECTUS_ADMIN_EMAIL: ci-admin@test.com
            DIRECTUS_ADMIN_PASSWORD: ci-test-password

            # Next.js Configuration
            NEXT_TELEMETRY_DISABLED: 1
            NODE_ENV: test

            # Development tools (disabled for CI)
            MILLION_LINT: false
            REACT_SCAN: false
            SHOW_AUTH_LOGS: false
            NEXT_PUBLIC_SHOW_AUTH_LOGS: false
            
            # Build optimization
            SKIP_STATIC_GENERATION: true

        steps:
            - name: ðŸ“š Checkout repository
              uses: actions/checkout@v4

            - name: ðŸ° Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: ${{ env.BUN_VERSION }}

            - name: ðŸ“¦ Install dependencies
              run: |
                if [ "${{ github.actor }}" = "dependabot[bot]" ]; then
                  echo "Dependabot PR detected: running bun install without --frozen-lockfile"
                  bun install
                else
                  bun install --frozen-lockfile
                fi

            - name: ðŸ“¥ Download declarative routes artifacts
              uses: actions/download-artifact@v4
              with:
                  name: declarative-routes
                  path: .

            - name: ðŸ” Verify downloaded artifacts
              run: |
                  echo "ðŸ“‹ Checking downloaded declarative routes artifacts..."
                  echo "Current directory: $(pwd)"
                  echo "Files in apps/web/src/routes/:"
                  ls -la apps/web/src/routes/ || echo "âŒ apps/web/src/routes/ directory not found"
                  echo "Checking for index.ts:"
                  if [ -f "apps/web/src/routes/index.ts" ]; then
                    echo "âœ… index.ts found"
                    head -5 apps/web/src/routes/index.ts
                  else
                    echo "âŒ index.ts not found"
                  fi
                  echo "Checking for openapi.ts:"
                  if [ -f "apps/web/src/routes/openapi.ts" ]; then
                    echo "âœ… openapi.ts found" 
                  else
                    echo "âŒ openapi.ts not found"
                  fi

            - name: ðŸ”§ Generate routes as fallback (if missing)
              run: |
                  if [ ! -f "apps/web/src/routes/index.ts" ]; then
                    echo "âš ï¸ index.ts missing, regenerating declarative routes..."
                    cd apps/web && bun run dr:build
                  else
                    echo "âœ… index.ts exists, skipping regeneration"
                  fi

            - name: ðŸ§ª Run tests for all packages
              run: bun run test

    # # Job 3: Merge Coverage Reports
    # merge-coverage:
    #     name: ðŸ“Š Merge Coverage Reports
    #     runs-on: ubuntu-latest
    #     timeout-minutes: 10
    #     needs: build-and-test
    #     if: always() && needs.build-and-test.result == 'success'
    #     env:
    #         # API Configuration
    #         API_URL: http://localhost:8055/
    #         API_PORT: 8055
    #         API_PING_PATH: /server/health
    #         API_ADMIN_TOKEN: ci-test-admin-token

    #         # App Configuration
    #         NEXT_PUBLIC_APP_URL: http://localhost:3003/
    #         NEXT_PUBLIC_APP_PORT: 3003

    #         # Database Configuration (for testing)
    #         DB_DATABASE: directus_test
    #         DB_ROOT_PASSWORD: test-password

    #         # Authentication
    #         AUTH_SECRET: ci-test-auth-secret-QgafJQw3O-k1gambz7YGKjtj5ZZe0dnL-WlSw4PtMDc

    #         # Directus Configuration
    #         DIRECTUS_SECRET: ci-test-directus-secret-value
    #         DIRECTUS_ADMIN_EMAIL: ci-admin@test.com
    #         DIRECTUS_ADMIN_PASSWORD: ci-test-password

    #         # Next.js Configuration
    #         NEXT_TELEMETRY_DISABLED: 1
    #         NODE_ENV: test

    #         # Development tools (disabled for CI)
    #         MILLION_LINT: false
    #         REACT_SCAN: false
    #         SHOW_AUTH_LOGS: false
    #         NEXT_PUBLIC_SHOW_AUTH_LOGS: false
            
    #         # Build optimization
    #         SKIP_STATIC_GENERATION: true

    #     steps:
    #         - name: ðŸ“š Checkout repository
    #           uses: actions/checkout@v4

    #         - name: ðŸ° Setup Bun
    #           uses: oven-sh/setup-bun@v2
    #           with:
    #               bun-version: ${{ env.BUN_VERSION }}

    #         - name: ðŸ“¦ Install dependencies
    #           run: |
    #             if [ "${{ github.actor }}" = "dependabot[bot]" ]; then
    #               echo "Dependabot PR detected: running bun install without --frozen-lockfile"
    #               bun install
    #             else
    #               bun install --frozen-lockfile
    #             fi

    #         - name: ðŸ—ï¸ Build all packages
    #           run: |
    #               # Generate declarative routes for web app before building
    #               bun run --cwd apps/web dr:build
    #               # Build shared packages first
    #               bun x turbo run build --filter="!web"
    #               # Build web app without static generation to avoid API calls
    #               bun run --cwd apps/web compile

    #         - name: ðŸ§ª Run all tests with coverage
    #           run: bun run test:coverage

    #         - name: ðŸ“Š Generate merged coverage report
    #           run: |
    #               mkdir -p coverage/report
    #               echo "ðŸ“‹ Coverage Summary:" > coverage/report/summary.txt
    #               if [ -f "coverage/report/index.html" ]; then
    #                 echo "âœ… Merged coverage report generated successfully" >> coverage/report/summary.txt
    #               else
    #                 echo "âš ï¸ No coverage data found" >> coverage/report/summary.txt
    #               fi

    #         - name: ðŸ“¤ Upload merged coverage artifact
    #           uses: actions/upload-artifact@v4
    #           with:
    #               name: coverage-report
    #               path: |
    #                   coverage/report/
    #                   coverage/coverage-final.json
    #               retention-days: 30

    #         - name: ðŸ“Š Upload to Codecov
    #           uses: codecov/codecov-action@v4
    #           with:
    #               files: ./coverage/coverage-final.json
    #               flags: merged
    #               name: merged-coverage
    #               fail_ci_if_error: false
    #           env:
    #               CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    # Job 4: Deployment Ready Check
    deployment-ready:
        name: ðŸš€ Deployment Ready
        runs-on: ubuntu-latest
        timeout-minutes: 5
        needs: [lint-and-typecheck, build, test, generate-declarative-routes]
        if: always()

        steps:
            - name: ðŸ“š Checkout repository
              uses: actions/checkout@v4

            - name: âœ… Check deployment readiness
              run: |
                  echo "ðŸ” Checking CI/CD pipeline results..."

                  LINT_STATUS="${{ needs.lint-and-typecheck.result }}"
                  BUILD_STATUS="${{ needs.build.result }}"
                  TEST_STATUS="${{ needs.test.result }}"
                  DR_STATUS="${{ needs.generate-declarative-routes.result }}"

                  echo "ðŸ“‹ Pipeline Results:"
                  echo "  - Lint & Type Check: $LINT_STATUS"
                  echo "  - Build: $BUILD_STATUS"
                  echo "  - Test: $TEST_STATUS"
                  echo "  - Declarative Routes: $DR_STATUS"

                  if [ "$LINT_STATUS" = "success" ] && [ "$BUILD_STATUS" = "success" ] && [ "$TEST_STATUS" = "success" ] && [ "$DR_STATUS" = "success" ]; then
                    if [ "${{ github.ref }}" = "refs/heads/main" ]; then
                      echo "ðŸš€ âœ… Ready for production deployment!"
                      echo "deployment_ready=true" >> $GITHUB_OUTPUT
                    else
                      echo "ðŸš€ âœ… Ready for staging deployment!"
                      echo "deployment_ready=true" >> $GITHUB_OUTPUT
                    fi
                  else
                    echo "ðŸš€ âŒ Not ready for deployment"
                    echo "deployment_ready=false" >> $GITHUB_OUTPUT
                    exit 1
                  fi

            - name: ðŸ“‹ Generate deployment summary
              run: |
                  echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
                  echo "| Lint & Type Check | ${{ needs.lint-and-typecheck.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Build | ${{ needs.build.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Test | ${{ needs.test.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Declarative Routes | ${{ needs.generate-declarative-routes.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  if [ "${{ github.ref }}" = "refs/heads/main" ]; then
                    echo "ðŸŽ¯ **Branch**: Production (main)" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "ðŸŽ¯ **Branch**: Development" >> $GITHUB_STEP_SUMMARY
                  fi
